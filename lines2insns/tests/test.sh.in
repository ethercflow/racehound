#!/bin/sh

########################################################################
# This test checks if lines2insns correctly finds the instruction locations
# for the racy accesses in test_common_target.ko.
# 
# Usage:
#   sh test.sh
########################################################################

# A function to check prerequisites: whether the necessary files exist,
# etc.
checkPrereqs()
{
	if test ! -f "${LINES_FILE}"; then
		printf "The list of source lines is missing: ${LINES_FILE}\n"
	fi

	if test ! -f "${BPS_FILE}"; then
		printf "The list of breakpoints is missing: ${BPS_FILE}\n"
	fi
}
########################################################################

doTest()
{
	insns_list="@CMAKE_CURRENT_BINARY_DIR@/insns01.list"
	"@CMAKE_BINARY_DIR@/lines2insns/lines2insns" "${MODULE}" \
		< "${LINES_FILE}" \
		> ${insns_list}
	
	if test $? -ne 0; then
		printf "Error occurred when running lines2insns.\n"
		exit 1
	fi
	
	printf "Found:\n"
	cat ${insns_list}
	
	found=0
	for insn in $(cat ${insns_list}); do
		grep $insn "${BPS_FILE}" > /dev/null
		if test $? -ne 0; then
			printf "Failed to find ${insn} in ${BPS_FILE}.\n"
			exit 1;
		fi
		found=1
	done
	
	if test ${found} -eq 0; then
		printf "lines2insns found nothing.\n"
		exit 1
	fi
}
########################################################################

WORK_DIR=${PWD}
BPS_FILE="@BPS_FILE@"
LINES_FILE="@CMAKE_CURRENT_SOURCE_DIR@/lines01.list"
MODULE="@CMAKE_BINARY_DIR@/core/tests/common_target/test_common_target.ko"

checkPrereqs
doTest

# Test passed
exit 0
